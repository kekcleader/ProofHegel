<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Сверка «Науки логики»</title>
<style>
:root {
  --bgcolor: #7fa2af;
  --fgcolor: #004b68;
  --highlight: #fff;
}
body {
  margin: 0;
  font-family: Verdana, sans-serif;
  font-size: 12px;
  color: var(--fgcolor);
  cursor: default;
}
.wrap {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
.header {
  text-align: center;
  background: var(--bgcolor);
  border-bottom: 1px solid var(--fgcolor);
  padding: 4px 3px;
}
.display {
  display: flex;
  justify-content: stretch;
  flex: 1;
}
.track {
  display: flex;
  flex: 1;
  flex-direction: column;
  border-right: 1px solid var(--fgcolor);
  background: var(--bgcolor);
}
.track:last-child {
  border-right: none;
}
.viewer {
  display: flex;
  flex: 1;
  flex-direction: column;
  border-bottom: 1px solid var(--fgcolor);
}
.viewer:last-child {
  border-bottom: none;
}
.menu {
  background: var(--fgcolor);
  color: var(--bgcolor);
  display: flex;
}
.menu .title {
  font-weight: bold;
  display: flex;
  align-items: center;
}
.menu > * {
  padding: 3px 5px;
}
.menu .page-btn {
  background: transparent;
  color: var(--bgcolor);
  border: none;
}
.menu .page-btn:hover {
  color: var(--highlight);
}
.menu .page-btn:hover:active {
  transform: translate(1px, 1px);
}
.menu .page {
  padding: 0;
  display: flex;
  flex-direction: column;
}
.menu .page input {
  background: transparent;
  color: var(--bgcolor);
  border: none;
  width: 30px;
  text-align: center;
  flex: 1;
  padding: 0;
}
.main {
  flex: 1;
  user-select: none;
  background-color: #bdcad0;
  background-repeat: no-repeat;
  background-position: 50% 0;
  background-size: 100%;
}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    Вычитка «Науки логики» Г. В. Ф. Гегеля
  </header>
  <main class="display">
    <section class="track">
      <article class="viewer">
        <section class="menu">
          <div class="title"></div>
          <button type="button" class="prev page-btn">Предыдущая стр.</button>
          <div class="page"><input type="text" value="1"></div>
          <button type="button" class="next page-btn">Следующая стр.</button>
        </section>
        <section class="main"></section>
      </article>
    </section>
  </main>
</div>
<script>
(()=>{
  let display = document.querySelector('.display');

  let viewer0 = display.querySelector('.viewer');
  viewer0.remove();

  let track0 = display.querySelector('.track');
  track0.remove();

  let movingObject = null;

  function UpdateHash() {
    let s = 'show:';
    let tracks = display.querySelectorAll('.track');
    let firstT = true;
    for (let track of tracks) {
      if (!firstT) s += ':T:'; else firstT = false;
      let viewers = track.querySelectorAll('.viewer');
      let firstV = true;
      for (let viewer of viewers) {
        if (!firstV) s += ':'; else firstV = false;
        s += viewer.dataset.key + '-' + viewer.dataset.page;
      }
    }
    location.hash = s;
  }

  function OpenTrack() {
    let t = track0.cloneNode();
    t.dataset.num = display.querySelectorAll('.track').length;
    display.append(t);
  }

  function OpenViewer(trackNum, viewer) {
    let track = display.querySelector('.track[data-num="' + trackNum + '"]');
    track.append(viewer);
    UpdateHash();
  }

  function MakeTitle(key) {
    let s;
    if (key == 'new') s = 'Новое издание';
    else if (parseInt(key) == key && key > 1700 & key < 3000)
      s = 'Издание ' + key + ' года';
    else s = key + '';
    return s;
  }

  function LoadTracks() {
    let s = (location.hash + '').substr(1);
    let m = s.split(':');
    if (s == '' || m[0] != 'show') {
      m = '1937-1:1970-1:T:new-1'.split(':');
    } else {
      m = m.slice(1);
    }
    OpenTrack();
    let t = 0;
    for (let x of m) {
      if (x == 'T') {
        OpenTrack();
        t++;
      } else {
        let m2 = x.split('-');
        let k = m2[0], p = m2[1];
        let v = NewViewer(MakeTitle(k), k);
        OpenViewer(t, v);
        if (p) SetPage(v, p);
      }
    }
  }

  function MainSetPos(main, x, y) {
    main.dataset.x = x;
    main.dataset.y = y;
    let z = parseInt(main.dataset.zoom);
    if (z < 100) x = 50;
    main.style.backgroundPosition = x + '% ' + y + 'px';
  }

  function MainRefreshPos(main) {
    MainSetPos(main, Number(main.dataset.x), parseInt(main.dataset.y));
  }

  function MainSetZoom(main, z) {
    let y = parseInt(main.dataset.y);
    let oldZ = main.dataset.zoom;
    let qz = z / oldZ;
    if (z < 100) {
      let maxH = main.clientWidth * z / 100 * 1.8;
      if (y < 0) y *= qz;
    } else if (y < 0) {
      y *= qz;
    }
    main.dataset.zoom = z;
    main.style.backgroundSize = z + '%';
    MainSetPos(main, Number(main.dataset.x), y);
  }

  function MainMouseDown(e) {
    e.preventDefault();
    movingObject = e.currentTarget;
  }

  function MainMouseUp(e) {
    e.preventDefault();
    movingObject = null;
  }

  function MainMouseMove(e) {
    e.preventDefault();
    if (movingObject && e.buttons != 0) {
      let main = movingObject;
      let dx = -e.movementX;
      let dy = e.movementY;
      let z = parseInt(main.dataset.zoom);
      let w = main.clientWidth;
      let W = w * z / 100;
      let x = Number(main.dataset.x);
      if (W != w) x = x + dx * 100 / (W - w);
      let y = parseInt(main.dataset.y) + dy;
      let minY = parseInt(main.dataset.minY) * z / 100;
      let maxY = parseInt(main.dataset.maxY) * z / 100;
      if (x < 0) x = 0; else if (x > 100) x = 100;
      if (y < minY) y = minY; else if (y > maxY) y = maxY;
      MainSetPos(main, x, y);
    }
  }

  function MainWheel(e) {
    e.preventDefault();
    let dz = -e.deltaY;
    if (dz != 0) {
      if (dz > 0) dz = 1; else dz = -1;
      let main = e.currentTarget;
      let z = parseInt(main.dataset.zoom);
      let newZ = parseInt(z * (1 + dz / 10.0));
      if (newZ > 40) newZ = Math.round(newZ / 10) * 10;
      if (z == newZ) z += dz; else z = newZ;

      const minZ = 1;
      const maxZ = 500;
      if (z < minZ) z = minZ; else if (z > maxZ) z = maxZ;
      MainSetZoom(main, z);
    }
  }

  function UpdatePage(viewer) {
    let main = viewer.querySelector('.main');
    let input = viewer.querySelector('.menu .page input');

    let p = parseInt(viewer.dataset.page);
    let key = viewer.dataset.key;
    input.value = p;
    let s = '00' + p;
    s = s.substr(s.length - 3);
    main.style.backgroundImage = 'url(\'' + key + '_1_png/page-' + s + '.png' + '\')';

    UpdateHash();
  }

  function SetPage(viewer, p) {
    let page = parseInt(viewer.dataset.page);
    let minPage = parseInt(viewer.dataset.minPage);
    let maxPage = parseInt(viewer.dataset.maxPage);
    if (p < minPage) p = minPage; else if (p > maxPage) p = maxPage;
    if (p != page) {
      viewer.dataset.page = p;
      UpdatePage(viewer);
    }
  }

  function IncPage(e, diff) {
    let viewer = e.currentTarget.closest('.viewer');
    let page = parseInt(viewer.dataset.page);
    let p = page + diff;
    SetPage(viewer, p);
  }

  function PrevClick(e) {
    IncPage(e, -1)
  }

  function NextClick(e) {
    IncPage(e, 1)
  }

  function PageChange(e) {
    let viewer = e.currentTarget.closest('.viewer');
    let p = parseInt(e.currentTarget.value);
    if (isNaN(p)) p = 1;
    SetPage(viewer, p);
  }

  function NewViewer(title, key) {
    let v = viewer0.cloneNode(true);
    let menu = v.querySelector('.menu');
    menu.querySelector('.title').innerHTML = title;
    v.dataset.key = key;

    let main = v.querySelector('.main');
    v.dataset.page = 1;
    UpdatePage(v);
    main.dataset.zoom = 100;
    main.dataset.minY = -1500;
    main.dataset.maxY = 3500;
    MainSetPos(main, 50, 0);

    main.addEventListener('mousedown', MainMouseDown);
    main.addEventListener('mouseup', MainMouseUp);
    main.addEventListener('mousemove', MainMouseMove);
    main.addEventListener('wheel', MainWheel);

    menu.querySelector('.prev').addEventListener('click', PrevClick);
    menu.querySelector('.next').addEventListener('click', NextClick);
    menu.querySelector('.page input').addEventListener('change', PageChange);

    return v;
  }

  LoadTracks();
})();
</script>
</body>
</html>
